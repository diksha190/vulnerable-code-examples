name: AI Security Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Clone Security Agent
        run: |
          git clone https://github.com/security-ai-labs/security-ai-agent.git
          cd security-ai-agent
          pip install -r requirements.txt
      
      - name: Create .env file
        run: |
          cd security-ai-agent
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
      
      - name: Get changed files
        id: changed-files
        run: |
          git diff --name-only \
            origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} \
            > changed_files.txt
          
          echo "üìÑ Changed files:"
          cat changed_files.txt
          
          if [ ! -s changed_files.txt ]; then
            echo "No files changed"
            echo "skip_analysis=true" >> $GITHUB_OUTPUT
          else
            echo "skip_analysis=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Analyze changed files
        if: steps.changed-files.outputs.skip_analysis == 'false'
        id: analyze
        run: |
          cd security-ai-agent
          
          while IFS= read -r file; do
            if [[ -f "../$file" ]]; then
              case "$file" in
                *.py|*.js|*.ts|*.sol|*.rs|*.go)
                  echo "üîç Analyzing: $file"
                  python cli.py "../$file" 2>&1 || echo "  ‚ö†Ô∏è  Analysis completed"
                  ;;
                *)
                  echo "‚è≠Ô∏è  Skipping: $file (unsupported file type)"
                  ;;
              esac
            fi
          done < ../changed_files.txt
          
          echo "üì¶ Moving reports to parent directory..."
          mv *_security_report.json ../ 2>/dev/null || echo "No reports to move"
          cd ..
          echo "üìã Reports in current directory:"
          ls -la *_security_report.json 2>/dev/null || echo "No report files found"
      
      - name: Post detailed PR comment
        if: steps.changed-files.outputs.skip_analysis == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            console.log('=== Starting PR comment generation ===');
            
            const files = fs.readdirSync('.');
            console.log('Files in directory:', files.filter(f => f.endsWith('.json')));
            
            const jsonFiles = files.filter(f => f.endsWith('_security_report.json'));
            console.log(`Found ${jsonFiles.length} report files`);
            
            let comment = '## üõ°Ô∏è AI Security Analysis\n\n';
            let totalVulns = 0;
            let totalCost = 0;
            
            if (jsonFiles.length === 0) {
              comment += '‚ö†Ô∏è **No security reports generated**\n\n';
              comment += 'This might mean:\n';
              comment += '- No supported files were changed (.py, .js, .ts, .sol, .rs, .go)\n';
              comment += '- Analysis failed (check workflow logs)\n\n';
            } else {
              jsonFiles.forEach(reportFile => {
                console.log(`Processing: ${reportFile}`);
                
                try {
                  const report = JSON.parse(fs.readFileSync(reportFile, 'utf8'));
                  const vulns = report.vulnerabilities || [];
                  const filePath = report.metadata?.filepath || reportFile.replace('_security_report.json', '');
                  const cost = report.metadata?.cost_usd || 0;
                  
                  totalVulns += vulns.length;
                  totalCost += cost;
                  
                  comment += `### üìÑ \`${filePath}\`\n\n`;
                  
                  if (vulns.length === 0) {
                    comment += '‚úÖ **No vulnerabilities detected!**\n\n';
                  } else {
                    const critical = vulns.filter(v => v.severity === 'CRITICAL');
                    const high = vulns.filter(v => v.severity === 'HIGH');
                    const medium = vulns.filter(v => v.severity === 'MEDIUM');
                    const low = vulns.filter(v => v.severity === 'LOW');
                    
                    comment += `‚ö†Ô∏è **Found ${vulns.length} issue(s)**: `;
                    comment += `${critical.length} Critical, ${high.length} High, ${medium.length} Medium, ${low.length} Low\n\n`;
                    
                    if (critical.length > 0) {
                      comment += '#### üö® Critical Issues\n\n';
                      critical.forEach((v, i) => {
                        comment += `**${i + 1}. ${v.title}**\n`;
                        comment += `- **Line**: ${v.line_number || '?'}\n`;
                        comment += `- **Description**: ${v.description || 'No description'}\n`;
                        comment += `- **Fix**: ${v.recommendation || 'No recommendation'}\n\n`;
                      });
                    }
                    
                    if (high.length > 0) {
                      comment += '#### ‚ö†Ô∏è High Severity Issues\n\n';
                      high.forEach((v, i) => {
                        comment += `**${i + 1}. ${v.title}**\n`;
                        comment += `- **Line**: ${v.line_number || '?'}\n`;
                        comment += `- **Description**: ${v.description || 'No description'}\n`;
                        comment += `- **Fix**: ${v.recommendation || 'No recommendation'}\n\n`;
                      });
                    }
                    
                    if (medium.length > 0) {
                      comment += '#### ‚ö° Medium Severity Issues\n\n';
                      medium.forEach((v, i) => {
                        comment += `${i + 1}. **${v.title}** (Line ${v.line_number || '?'})\n`;
                      });
                      comment += '\n';
                    }
                    
                    if (low.length > 0) {
                      comment += '#### ‚ÑπÔ∏è Low Severity Issues\n\n';
                      low.forEach((v, i) => {
                        comment += `${i + 1}. **${v.title}** (Line ${v.line_number || '?'})\n`;
                      });
                      comment += '\n';
                    }
                  }
                  
                  comment += `üí∞ Analysis cost: $${cost.toFixed(4)}\n\n`;
                  comment += '---\n\n';
                  
                } catch (err) {
                  console.error(`Error processing ${reportFile}:`, err);
                  comment += `### ‚ùå Error processing ${reportFile}\n\n`;
                  comment += `${err.message}\n\n`;
                }
              });
              
              comment += `## üìä Summary\n\n`;
              comment += `- **Total vulnerabilities**: ${totalVulns}\n`;
              comment += `- **Files analyzed**: ${jsonFiles.length}\n`;
              comment += `- **Total cost**: $${totalCost.toFixed(4)}\n\n`;
            }
            
            comment += '---\n';
            comment += 'ü§ñ Powered by [AI Security Agent](https://github.com/security-ai-labs/security-ai-agent)\n';
            
            console.log('Posting comment...');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            console.log('Comment posted successfully!');