name: AI Security Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Clone Security Agent
        run: |
          git clone https://github.com/security-ai-labs/security-ai-agent.git
          cd security-ai-agent
          pip install -r requirements.txt
      
      - name: Create .env file
        run: |
          cd security-ai-agent
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files
          git diff --name-only \
            origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} \
            > changed_files.txt
          
          echo "üìÑ Changed files:"
          cat changed_files.txt
          
          # Check if any files changed
          if [ ! -s changed_files.txt ]; then
            echo "No files changed"
            echo "skip_analysis=true" >> $GITHUB_OUTPUT
          else
            echo "skip_analysis=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Analyze changed files
        if: steps.changed-files.outputs.skip_analysis == 'false'
        id: analyze
        continue-on-error: true
        run: |
          cd security-ai-agent
          
          # Read changed files and analyze each
          results_file="../analysis_results.json"
          
          echo '{
            "total_vulnerabilities": 0,
            "total_files": 0,
            "total_cost": 0.0,
            "files": []
          }' > "$results_file"
          
          # Analyze each changed file
          while IFS= read -r file; do
            if [[ -f "../$file" ]]; then
              # Check if it's a code file we support
              case "$file" in
                *.py|*.js|*.ts|*.sol|*.rs|*.go)
                  echo "üîç Analyzing: $file"
                  
                  # Run analysis
                  if python cli.py "../$file" 2>&1; then
                    echo "  ‚úÖ Analysis complete"
                  else
                    echo "  ‚ö†Ô∏è  Analysis failed or found issues"
                  fi
                  ;;
                *)
                  echo "‚è≠Ô∏è  Skipping: $file (unsupported file type)"
                  ;;
              esac
            fi
          done < ../changed_files.txt
      
      - name: Simple PR Comment
        if: steps.changed-files.outputs.skip_analysis == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let comment = '## üõ°Ô∏è AI Security Analysis\n\n';
            
            // Read changed files
            const changedFiles = fs.readFileSync('changed_files.txt', 'utf8')
              .split('\n')
              .filter(f => f.trim());
            
            comment += `‚úÖ Analyzed ${changedFiles.length} changed file(s)\n\n`;
            
            changedFiles.forEach(file => {
              const reportFile = file.replace(/\.[^/.]+$/, '') + '_security_report.json';
              
              if (fs.existsSync(reportFile)) {
                const report = JSON.parse(fs.readFileSync(reportFile, 'utf8'));
                const vulns = report.vulnerabilities || [];
                
                if (vulns.length > 0) {
                  comment += `### üìÑ \`${file}\`\n\n`;
                  comment += `‚ö†Ô∏è Found ${vulns.length} issue(s):\n\n`;
                  
                  vulns.forEach(vuln => {
                    const emoji = {
                      'CRITICAL': 'üö®',
                      'HIGH': '‚ö†Ô∏è',
                      'MEDIUM': '‚ö°',
                      'LOW': '‚ÑπÔ∏è'
                    }[vuln.severity] || 'üìå';
                    
                    comment += `${emoji} **${vuln.severity}**: ${vuln.title}\n`;
                    comment += `- Line ${vuln.line_number || '?'}\n`;
                    comment += `- ${vuln.description}\n\n`;
                  });
                } else {
                  comment += `### üìÑ \`${file}\` ‚úÖ\n\nNo issues found\n\n`;
                }
              }
            });
            
            comment += '\n---\n';
            comment += 'ü§ñ Powered by [AI Security Agent](https://github.com/security-ai-labs/security-ai-agent)\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });